<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>spectrum.source_bin_ops &#8212; 1D Spectrum QSO Library 2.0a documentation</title>

    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css"/>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css"/>

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0a',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };

    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html"/>
    <link rel="search" title="Search" href="../../search.html"/>

    <link rel="stylesheet" href="../../_static/custom.css" type="text/css"/>


    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9"/>

</head>
<body role="document">


<div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="body" role="main">

                <h1>Source code for spectrum.source_bin_ops</h1>
                <div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HERE BE DRAGONS:  This package was written over the course of an extremely hectic night well fueled by copious</span>
<span class="sd">    amounts of coffee and stress.  It works, but there is not guarantee that it is a) efficient or b) error-safe.</span>


<span class="sd">The entire purpose of this package is to solve a problem that shows up from the way the SDSS packs wavelengths - more </span>
<span class="sd">aptly, that they do not.  The ith wavelength in a 1D spectrum is generated by pow( c0 + c1*i, 10 ) - i.e. they are</span>
<span class="sd">nonlinear.  Thus, where a binned, rest frame spectrum is desired, the binning must be done first,  Only then can it</span>
<span class="sd">be shifted to rest.</span>

<span class="sd">The challenge here is to bin the spectrum - in its source frame - into a scheme that, when shifted back to rest frame</span>
<span class="sd">will have integer wavelengths, spaced 1 angstrom apart.</span>

<span class="sd">As it stands, this can be achieved from this package by loading a source frame, unbinned Spectrum (s_spec), and </span>
<span class="sd">performing the process:</span>

<span class="sd">binned_spec = source_bin( s_spec )</span>
<span class="sd">r_spec = binned_source_to_rest( binned_spec )</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">catalog</span> <span class="k">import</span> <span
                        class="n">shenCat</span>
<span class="kn">from</span> <span class="nn">spectrum</span> <span class="k">import</span> <span
                        class="n">Spectrum</span>


<div class="viewcode-block" id="source_frame_step"><a class="viewcode-back"
                                                      href="../../index.html#spectrum.source_bin_ops.source_frame_step">[docs]</a><span
        class="k">def</span> <span class="nf">source_frame_step</span><span class="p">(</span> <span
        class="n">spec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span> <span
        class="n">Spectrum</span><span class="p">,</span> <span class="nb">str</span> <span class="p">],</span> <span
        class="n">desired_step</span><span class="p">:</span> <span class="nb">float</span> <span
        class="o">=</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">-&gt;</span> <span
        class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the step size necessary (in the spectrum&#39;s source frame) which will yield the desired_step</span>
<span class="sd">    when the spectrum is shifted back to rest.</span>

<span class="sd">    :param spec:</span>
<span class="sd">    :param desired_step:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">spec</span> <span
            class="p">)</span> <span class="o">==</span> <span class="n">Spectrum</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">getNS</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">shenCat</span><span class="o">.</span><span
            class="n">subkey</span><span class="p">(</span> <span class="n">spec</span><span class="p">,</span> <span
            class="s1">&#39;z&#39;</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span
            class="n">z</span><span class="p">)</span> <span class="o">*</span> <span
            class="n">desired_step</span></div>


<div class="viewcode-block" id="init_source_wl"><a class="viewcode-back"
                                                   href="../../index.html#spectrum.source_bin_ops.init_source_wl">[docs]</a><span
        class="k">def</span> <span class="nf">init_source_wl</span><span class="p">(</span> <span
        class="n">spec</span><span class="p">:</span> <span class="n">Spectrum</span> <span class="p">)</span> <span
        class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When binning a source spectrum with the intention of shifting it back to rest frame and avoid re-binning,</span>
<span class="sd">    this method what the desired first wavelength should be in the source frame.</span>

<span class="sd">    Operates under the assumption that the desired rest frame bins are integer wavelength values.</span>

<span class="sd">    ie. if first wl in spectrum is 3805.43 at a redshift of z = 0.55, the first rest frame wavelength is 2454.4709...</span>
<span class="sd">    Thus, the first (integer wavelength) bin begins at 2454.</span>

<span class="sd">    Returning to the source frame, this becomes 3805.12.</span>
<span class="sd">    This method would, in this case, return 3805.12.  Pass this to the source binning process and it will begin the</span>
<span class="sd">    binning process there.</span>


<span class="sd">    :param spec: Source frame spectrum</span>
<span class="sd">    :type spec: Spectrum</span>
<span class="sd">    :return: initial source bin wavelength</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">shenCat</span><span class="o">.</span><span
            class="n">subkey</span><span class="p">(</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">getNS</span><span class="p">(),</span> <span class="s1">&#39;z&#39;</span> <span
            class="p">)</span>
    <span class="n">first_wl</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">getWavelengths</span><span class="p">()[</span> <span class="mi">0</span> <span class="p">]</span> <span
            class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span
            class="n">z</span><span class="p">)</span>
    <span class="n">first_wl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span
            class="n">first_wl</span> <span class="p">)</span>
    <span class="n">first_wl</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span
            class="o">+</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">first_wl</span></div>


<div class="viewcode-block" id="source_bin"><a class="viewcode-back"
                                               href="../../index.html#spectrum.source_bin_ops.source_bin">[docs]</a><span
        class="k">def</span> <span class="nf">source_bin</span><span class="p">(</span> <span class="n">spec</span><span
        class="p">:</span> <span class="n">Spectrum</span><span class="p">,</span> <span class="n">step</span><span
        class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span
        class="p">,</span> <span class="n">init_wl</span><span class="p">:</span> <span class="nb">float</span> <span
        class="o">=</span> <span class="kc">None</span> <span class="p">)</span> <span class="o">-&gt;</span> <span
        class="n">Spectrum</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bins a spectrum beginning given initial wavelength and desired bin spacing (step).  If step and init_wl are not</span>
<span class="sd">    passed, this method will detrmine them directly from the source spectrum such that the rest frame spectrum has</span>
<span class="sd">    integer wavelengths spaced by 1 Angstrom steps.</span>

<span class="sd">    Intended to be used to bin a source spectrum which will then be shifted back into rest frame (via</span>
<span class="sd">    binned_source_to_rest).  The rest frame spectrum will already be binned as a result.  </span>
<span class="sd">    </span>
<span class="sd">    :param step: Desired source frame bin spacing.  Will call source_frame_step( spec, 1 ) if this is not passed.</span>
<span class="sd">    :param init_wl: Desired inital bin wavelength.  Will call init_source_wl( spec ) if this is not passed.</span>
<span class="sd">    :type spec: Spectrum</span>
<span class="sd">    :type step: float</span>
<span class="sd">    :type init_wl: float</span>
<span class="sd">    :return: Binned source spectrum</span>
<span class="sd">    :rtype: Spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span
            class="n">std</span><span class="p">,</span> <span class="n">mean</span>

    <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="ow">or</span> <span
            class="n">source_frame_step</span><span class="p">(</span> <span class="n">spec</span><span
            class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="n">oldwls</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">getWavelengths</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">init_wl</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
        <span class="n">init_wl</span> <span class="o">=</span> <span class="n">init_source_wl</span><span
            class="p">(</span> <span class="n">spec</span> <span class="p">)</span>

    <span class="n">max_wl</span> <span class="o">=</span> <span class="n">oldwls</span><span class="p">[</span> <span
            class="o">-</span><span class="mi">1</span> <span class="p">]</span>

    <span class="n">newwls</span> <span class="o">=</span> <span class="p">[</span> <span class="n">init_wl</span> <span
            class="p">]</span>

    <span class="n">flxlist</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
    <span class="n">errlist</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
    <span class="n">newi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">oldi</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">neww</span> <span class="o">=</span> <span class="n">newwls</span><span class="p">[</span> <span
            class="n">newi</span> <span class="p">]</span>
    <span class="n">oldw</span> <span class="o">=</span> <span class="n">oldwls</span><span class="p">[</span> <span
            class="n">oldi</span> <span class="p">]</span>
    <span class="k">while</span> <span class="n">neww</span> <span class="o">+</span> <span class="n">step</span> <span
            class="o">&lt;</span> <span class="n">max_wl</span><span class="p">:</span>  <span class="c1"># Run until the last wavelength in spec is binned</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>  <span
            class="c1"># clear the current range of flux values</span>
        <span class="k">while</span> <span class="n">oldw</span> <span class="o">&lt;</span> <span class="n">neww</span> <span
            class="o">+</span> <span class="n">step</span><span class="p">:</span>  <span class="c1"># while the old wl is in the current bin, get its flux and advance to the next</span>
            <span class="n">flux</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span> <span class="n">spec</span><span class="o">.</span><span class="n">getFlux</span><span
            class="p">(</span> <span class="n">oldw</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">oldi</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">oldw</span> <span class="o">=</span> <span class="n">oldwls</span><span
            class="p">[</span> <span class="n">oldi</span> <span class="p">]</span>

        <span class="c1"># see if the flux has more than one value (if so, take the mean and set the err as std deviation)</span>
        <span class="c1"># otherwise, assign it that value and error</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">flux</span> <span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span> <span
            class="n">flux</span> <span class="p">)</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="nb">float</span><span
            class="p">(</span> <span class="n">mean</span><span class="p">(</span> <span class="n">flux</span> <span
            class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span> <span
            class="n">flux</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span
            class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">getErr</span><span class="p">(</span> <span class="n">oldwls</span><span class="p">[</span> <span
            class="n">oldi</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span
            class="p">)</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span
            class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

        <span class="c1"># if there were no values in this bin range (i.e. the flux variable is still a list, albiet an empty one)</span>
        <span class="c1"># then something&#39;s wrong.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">flux</span> <span
            class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">flxlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span
            class="n">flux</span> <span class="p">)</span>
            <span class="n">errlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span
            class="n">err</span> <span class="p">)</span>
            <span class="k">while</span> <span class="n">neww</span> <span class="o">+</span> <span
            class="n">step</span> <span class="o">&lt;</span> <span class="n">oldw</span><span class="p">:</span>
                <span class="n">neww</span> <span class="o">+=</span> <span class="n">step</span>
            <span class="n">newwls</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span> <span class="n">neww</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Well, this is awkward.  You&#39;re probably caught in an infinte loop.&quot;</span> <span
            class="p">)</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">f</span><span
            class="s2">&quot;New WL:</span><span class="si">{new}</span><span class="s2">, Last old wl:</span><span
            class="si">{oldw}</span><span class="s2"> on spectrun:{spec.getNS()}&quot;</span> <span class="p">)</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">cpy_info</span><span class="p">()</span>
    <span class="n">spec</span><span class="o">.</span><span class="n">setDict</span><span class="p">(</span> <span
            class="n">newwls</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span
            class="mi">1</span> <span class="p">],</span> <span class="n">flxlist</span><span class="p">,</span> <span
            class="n">errlist</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">spec</span></div>


<div class="viewcode-block" id="binned_source_to_rest"><a class="viewcode-back"
                                                          href="../../index.html#spectrum.source_bin_ops.binned_source_to_rest">[docs]</a><span
        class="k">def</span> <span class="nf">binned_source_to_rest</span><span class="p">(</span> <span
        class="n">spec</span><span class="p">:</span> <span class="n">Spectrum</span><span class="p">,</span> <span
        class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span
        class="kc">None</span> <span class="p">)</span> <span class="o">-&gt;</span> <span
        class="n">Spectrum</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes in a binned source spectrum and shifts it to rest frame.</span>

<span class="sd">    WARNING:  Assumes desired wavelengths will be integer values and called (int) on them as a result.  If integer</span>
<span class="sd">    wavelengths are NOT desired, this method will need to be modified.</span>

<span class="sd">    :param spec: Binned source spectrum</span>
<span class="sd">    :type spec: Spectrum</span>
<span class="sd">    :param z: Original redshift.  If not passed, it will call spec.getRS() and use that value.</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :return: Rest frame spectrum</span>
<span class="sd">    :rtype: Spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">cpy</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="ow">or</span> <span
            class="n">spec</span><span class="o">.</span><span class="n">getRS</span><span class="p">()</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span
            class="n">getWavelengths</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span
            class="n">wls</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">wl</span> <span class="ow">in</span> <span class="n">wls</span><span
            class="p">:</span>
        <span class="n">spec</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span> <span
            class="n">wl</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span
            class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="p">)</span> <span
            class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span> <span
            class="n">wl</span> <span class="p">]</span>
        <span class="k">del</span> <span class="n">spec</span><span class="p">[</span> <span class="n">wl</span> <span
            class="p">]</span>
    <span class="k">return</span> <span class="n">spec</span></div>
</pre>
                </div>

            </div>
        </div>
    </div>
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <div class="relations">
                <h3>Related Topics</h3>
                <ul>
                    <li><a href="../../index.html">Documentation overview</a>
                        <ul>
                            <li><a href="../index.html">Module code</a>
                                <ul>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div id="searchbox" style="display: none" role="search">
                <h3>Quick search</h3>
                <form class="search" action="../../search.html" method="get">
                    <div><input type="text" name="q"/></div>
                    <div><input type="submit" value="Go"/></div>
                    <input type="hidden" name="check_keywords" value="yes"/>
                    <input type="hidden" name="area" value="default"/>
                </form>
            </div>
            <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
    </div>
    <div class="clearer"></div>
</div>
<div class="footer">
    &copy;2017, Christopher Wahl.

    |
    Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.4</a>
    &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>

</div>


</body>
</html>